<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Contacts Tool</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@stlite/browser@0.76.0/build/style.css" />
  </head>
  <body>
    <div id="stlite-app"></div>
    <script type="module">
      import { mount } from "https://cdn.jsdelivr.net/npm/@stlite/browser@0.76.0/build/stlite.js";

      mount(
        `
import streamlit as st
import pandas as pd
import warnings
from pandas.errors import SettingWithCopyWarning

warnings.simplefilter(action="ignore", category=SettingWithCopyWarning)

st.set_page_config(page_title="Process Contacts")
st.title("Process NVEST Contacts")
st.markdown("[See repo README for processing logic â†’](https://github.com/data-to-insight/d2i-contacts/blob/main/README.md)")

uploaded_main = st.file_uploader("Upload main D2I contacts CSV", type=["csv"], key="main_contacts")
uploaded_wix = st.file_uploader("Upload Wix contacts CSV", type=["csv"], key="wix_contacts")

all_contacts = None
df_main = None
df_wix = None

if uploaded_main is not None:
    try:
        df_main = pd.read_csv(uploaded_main)
        df_main.columns = df_main.columns.str.strip().str.lower()

        df_main.rename(columns={
            "first_name": "first_name",
            "last_name": "last_name",
            "la": "local_authority",
            "email": "email",
            "job_title": "role",
            "created at (utc+0)": "submission_date"
        }, inplace=True)

        df_main["email"] = df_main["email"].astype(str).str.strip().str.lower()
        df_main["domain"] = df_main["email"].str.extract(r"@(.+)$")[0]
        df_main["source"] = "Main"

        st.success(f"Main contacts loaded: {uploaded_main.name}")

    except Exception as e:
        st.error(f"Error loading main contacts: {e}")
        df_main = None

if uploaded_wix is not None:
    try:
        df_wix = pd.read_csv(uploaded_wix)
        df_wix.columns = df_wix.columns.str.strip().str.lower()

        df_wix.rename(columns={"email 1": "email"}, inplace=True)
        df_wix["email"] = df_wix["email"].astype(str).str.strip().str.lower()
        df_wix["domain"] = df_wix["email"].str.extract(r"@(.+)$")[0]
        df_wix["source"] = "Wix"

        if df_main is not None:
            existing_emails = df_main["email"].dropna().unique()
            df_wix = df_wix[~df_wix["email"].isin(existing_emails)]

        st.success(f"Wix contacts loaded and filtered: {uploaded_wix.name}")

    except Exception as e:
        st.error(f"Error loading Wix contacts: {e}")
        df_wix = None

if df_main is not None:
    all_contacts = df_main.copy()
    df_wix = df_wix if df_wix is not None else pd.DataFrame()

    if not df_wix.empty:
        df_wix["new_contact"] = "Y"
        df_main["new_contact"] = "N"
        all_contacts = pd.concat([all_contacts, df_wix], ignore_index=True)
    else:
        all_contacts["new_contact"] = "N"

    all_contacts.drop_duplicates(subset="email", keep="first", inplace=True)

    # standardise display fields
    for col in ["first_name", "last_name", "local_authority", "role"]:
        if col in all_contacts.columns:
            all_contacts[col] = all_contacts[col].astype(str).str.strip().str.title()

    if "first_name" in all_contacts.columns:
        all_contacts.sort_values(by="first_name", inplace=True)

    st.subheader("Preview of Contacts (Green = new Wix contact)")

    preview_cols = ["first_name", "last_name", "local_authority", "email", "domain", "source", "new_contact"]
    
    def highlight_new(row):
        return ["background-color: #d4edda" if row.get("new_contact") == "Y" else "" for _ in row]

    st.dataframe(all_contacts[preview_cols].style.apply(highlight_new, axis=1))

    st.subheader("Summary by Source")
    st.write(all_contacts["source"].value_counts().rename_axis("source").reset_index(name="count"))

    st.subheader("Top Domains")
    st.write(all_contacts["domain"].value_counts().head(10).rename_axis("domain").reset_index(name="count"))

    csv_data = all_contacts.to_csv(index=False).encode("utf-8")
    st.download_button(
        label="Download Merged Contacts",
        data=csv_data,
        file_name=f"d2i_merged_contacts_{pd.Timestamp.now().strftime('%Y%m%d_%H%M%S')}.csv",
        mime="text/csv"
    )
else:
    st.warning("Upload and process at least the main contacts file to proceed.")
        `,
        document.getElementById("stlite-app")
      );
    </script>
  </body>
</html>
